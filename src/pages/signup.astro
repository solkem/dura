---
import BaseLayout from "../layouts/BaseLayout.astro";
import { db } from "../db";
import { invitations } from "../db/schema";
import { eq } from "drizzle-orm";

if (Astro.locals.user) {
	return Astro.redirect("/");
}

const inviteToken = Astro.url.searchParams.get("invite");
let inviteValid = false;
let inviteEmail = "";
let inviteRole = "";

// Validate invite token directly from database (SSR can't fetch its own API reliably)
if (inviteToken) {
    console.log("Checking invite token:", inviteToken);
    try {
        const invite = await db.select().from(invitations).where(eq(invitations.token, inviteToken)).get();
        console.log("Invite query result:", invite);
        
        if (invite && !invite.usedAt && invite.expiresAt > Date.now()) {
            inviteValid = true;
            inviteEmail = invite.email;
            inviteRole = invite.role;
            console.log("Invite valid!");
        } else {
            console.log("Invite invalid:", { 
                exists: !!invite, 
                used: invite?.usedAt, 
                expired: invite ? invite.expiresAt < Date.now() : null 
            });
        }
    } catch (e) {
        console.error("Invite validation error:", e);
    }
}
---

<BaseLayout title="Sign up | Dura">
	<div class="max-w-md mx-auto mt-20 mb-20 p-8 bg-white border border-stone-200 rounded-2xl shadow-sm">
		{!inviteToken ? (
            <!-- No invite token provided -->
            <div class="text-center">
                <h1 class="text-3xl font-bold text-stone-900 mb-4">Invite Required</h1>
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
                    <p class="text-amber-800">
                        Dura is an invite-only research collaboration platform. 
                        You need an invitation link to create an account.
                    </p>
                </div>
                <p class="text-stone-600 mb-6">
                    If you're a researcher or contributor interested in joining, please contact the project team.
                </p>
                <a href="mailto:solomonkembo@gmail.com" class="inline-block bg-stone-900 text-white font-bold py-3 px-6 rounded-lg hover:bg-stone-800 transition-colors">
                    Request Access
                </a>
                <div class="mt-6 text-sm text-stone-600">
                    Already have an account? <a href="/login" class="text-amber-700 font-bold hover:underline">Sign in</a>
                </div>
            </div>
        ) : !inviteValid ? (
            <!-- Invalid or expired token -->
            <div class="text-center">
                <h1 class="text-3xl font-bold text-red-600 mb-4">Invalid Invitation</h1>
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                    <p class="text-red-800">
                        This invitation link is invalid, expired, or has already been used.
                    </p>
                </div>
                <p class="text-stone-600 mb-6">
                    Please request a new invitation from the project team.
                </p>
                <a href="/" class="inline-block bg-stone-900 text-white font-bold py-3 px-6 rounded-lg hover:bg-stone-800 transition-colors">
                    Go Home
                </a>
            </div>
        ) : (
            <!-- Valid invite - show signup form -->
            <>
                <h1 class="text-3xl font-bold text-stone-900 mb-2 text-center">Create your account</h1>
                <p class="text-center text-stone-600 mb-6">
                    You've been invited as a <span class="font-bold text-amber-700 capitalize">{inviteRole}</span>
                </p>
                
                <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-6 text-sm">
                    <p class="text-green-800">
                        <span class="font-bold">Email:</span> {inviteEmail}
                    </p>
                </div>
                
                <form method="post" action="/api/signup" class="space-y-4">
                    <input type="hidden" name="invite" value={inviteToken} />
                    
                    <div>
                        <label for="username" class="block text-sm font-medium text-stone-700 mb-1">Username</label>
                        <input 
                            name="username" 
                            id="username" 
                            required 
                            class="w-full px-4 py-2 border border-stone-200 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent outline-none transition-all"
                        />
                        <p class="text-xs text-stone-500 mt-1">3-31 characters, lowercase letters, numbers, underscores only.</p>
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-stone-700 mb-1">Password</label>
                        <input 
                            type="password" 
                            name="password" 
                            id="password" 
                            required 
                            class="w-full px-4 py-2 border border-stone-200 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent outline-none transition-all"
                        />
                        <p class="text-xs text-stone-500 mt-1">Minimum 6 characters.</p>
                    </div>
                    <button class="w-full bg-stone-900 text-white font-bold py-3 rounded-lg hover:bg-stone-800 transition-colors mt-6">Create Account</button>
                    <p id="form-error" class="text-red-600 text-sm mt-4 text-center hidden"></p>
                </form>
            </>
        )}
	</div>

    <script>
        const form = document.forms[0];
        const errorMessageElement = document.getElementById("form-error");
    
        if (form && errorMessageElement) {
            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                errorMessageElement.innerText = "";
                errorMessageElement.classList.add("hidden");
                
                const formElement = e.target as HTMLFormElement;
                const response = await fetch(formElement.action, {
                    method: formElement.method,
                    body: new FormData(formElement)
                });
                
                if (response.ok) {
                    window.location.href = "/";
                } else {
                    try {
                        const data = await response.json();
                        errorMessageElement.innerText = data.error;
                        errorMessageElement.classList.remove("hidden");
                    } catch {
                        errorMessageElement.innerText = "An error occurred";
                        errorMessageElement.classList.remove("hidden");
                    }
                }
            });
        }
    </script>
</BaseLayout>
