---
import BaseLayout from "../layouts/BaseLayout.astro";

export const prerender = false;

// Check if user is admin
const user = Astro.locals.user;
if (!user) {
    return Astro.redirect("/login");
}
if (user.role !== "admin") {
    return Astro.redirect("/");
}
---

<BaseLayout title="Admin - Invitations | Dura">
    <div class="max-w-2xl mx-auto mt-12 mb-20 p-8 bg-white border border-stone-200 rounded-2xl shadow-sm">
        <h1 class="text-3xl font-bold text-stone-900 mb-2">Invite Management</h1>
        <p class="text-stone-600 mb-8">Create invitation links for researchers and contributors.</p>
        
        <form id="invite-form" class="space-y-4 mb-8">
            <div>
                <label for="email" class="block text-sm font-medium text-stone-700 mb-1">Email Address</label>
                <input 
                    type="email"
                    name="email" 
                    id="email" 
                    required 
                    placeholder="researcher@example.com"
                    class="w-full px-4 py-2 border border-stone-200 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent outline-none transition-all"
                />
            </div>
            <div>
                <label for="role" class="block text-sm font-medium text-stone-700 mb-1">Role</label>
                <select 
                    name="role" 
                    id="role"
                    class="w-full px-4 py-2 border border-stone-200 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent outline-none transition-all"
                >
                    <option value="researcher">Researcher (Read access to papers)</option>
                    <option value="contributor">Contributor (Can edit content)</option>
                </select>
            </div>
            <button 
                type="submit"
                class="w-full bg-amber-600 text-white font-bold py-3 rounded-lg hover:bg-amber-700 transition-colors mt-4"
            >
                Generate Invitation Link
            </button>
        </form>

        <div id="result" class="hidden">
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <h3 class="font-bold text-green-800 mb-2">Invitation Created!</h3>
                <p class="text-sm text-green-700 mb-2">Send this link to <span id="result-email" class="font-bold"></span>:</p>
                <div class="flex items-center gap-2">
                    <input 
                        type="text" 
                        id="invite-link" 
                        readonly 
                        class="flex-1 px-3 py-2 bg-white border border-green-300 rounded-lg text-sm font-mono"
                    />
                    <button 
                        id="copy-btn"
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm"
                    >
                        Copy
                    </button>
                </div>
                <p class="text-xs text-green-600 mt-2">Expires in 7 days</p>
            </div>
        </div>

        <div id="error" class="hidden bg-red-50 border border-red-200 rounded-lg p-4">
            <p class="text-red-800" id="error-message"></p>
        </div>
    </div>

    <script>
        const form = document.getElementById("invite-form") as HTMLFormElement;
        const resultDiv = document.getElementById("result")!;
        const errorDiv = document.getElementById("error")!;
        const errorMessage = document.getElementById("error-message")!;
        const inviteLinkInput = document.getElementById("invite-link") as HTMLInputElement;
        const resultEmail = document.getElementById("result-email")!;
        const copyBtn = document.getElementById("copy-btn")!;

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            resultDiv.classList.add("hidden");
            errorDiv.classList.add("hidden");

            const formData = new FormData(form);
            const response = await fetch("/api/invite", {
                method: "POST",
                body: formData
            });

            const data = await response.json();

            if (response.ok) {
                inviteLinkInput.value = data.inviteLink;
                resultEmail.textContent = data.email;
                resultDiv.classList.remove("hidden");
            } else {
                errorMessage.textContent = data.error || "Failed to create invitation";
                errorDiv.classList.remove("hidden");
            }
        });

        copyBtn.addEventListener("click", () => {
            inviteLinkInput.select();
            navigator.clipboard.writeText(inviteLinkInput.value);
            copyBtn.textContent = "Copied!";
            setTimeout(() => {
                copyBtn.textContent = "Copy";
            }, 2000);
        });
    </script>
</BaseLayout>
