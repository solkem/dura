---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { db } from "../../db";
import { memories } from "../../db/schema";
import { eq, desc } from "drizzle-orm";

export const prerender = false;

// Admin only
if (!Astro.locals.user || Astro.locals.user.role !== 'admin') {
    return Astro.redirect('/login');
}

// Get counts for each status
const pendingMemories = await db.select().from(memories)
    .where(eq(memories.status, 'pending'))
    .orderBy(desc(memories.createdAt));

const validatedMemories = await db.select().from(memories)
    .where(eq(memories.status, 'validated'))
    .orderBy(desc(memories.createdAt));

const rejectedMemories = await db.select().from(memories)
    .where(eq(memories.status, 'rejected'))
    .orderBy(desc(memories.createdAt));

const pendingCount = pendingMemories.length;
const validatedCount = validatedMemories.length;
const rejectedCount = rejectedMemories.length;
---

<BaseLayout title="Memory Management | Dura">
    <div class="memories-admin">
        <h1>üß† Nyakupfuya Memories</h1>
        <p class="description">
            Review and approve learned patterns. Only validated memories influence future processing.
        </p>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="pending">
                Pending <span class="badge pending">{pendingCount}</span>
            </button>
            <button class="tab" data-tab="validated">
                Validated <span class="badge validated">{validatedCount}</span>
            </button>
            <button class="tab" data-tab="rejected">
                Rejected <span class="badge rejected">{rejectedCount}</span>
            </button>
        </div>

        <!-- Pending Tab -->
        <div id="pending-tab" class="tab-content active">
            {pendingMemories.length === 0 ? (
                <div class="empty-state">
                    <p>‚ú® No pending memories to review</p>
                </div>
            ) : (
                <div class="memory-list">
                    {pendingMemories.map((memory) => (
                        <div class="memory-card pending" data-id={memory.id}>
                            <div class="memory-header">
                                <span class="memory-type">{memory.type}</span>
                                <span class="memory-confidence">
                                    Confidence: {((memory.confidence || 0) * 100).toFixed(0)}%
                                </span>
                            </div>
                            <p class="memory-content">{memory.content}</p>
                            {memory.sourceAgent && (
                                <p class="memory-source">Source: {memory.sourceAgent}</p>
                            )}
                            <p class="memory-date">
                                Created: {new Date(memory.createdAt || '').toLocaleDateString()}
                            </p>
                            <div class="memory-actions">
                                <button class="btn approve" onclick={`approveMemory('${memory.id}')`}>
                                    ‚úÖ Approve
                                </button>
                                <button class="btn reject" onclick={`rejectMemory('${memory.id}')`}>
                                    ‚ùå Reject
                                </button>
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>

        <!-- Validated Tab -->
        <div id="validated-tab" class="tab-content">
            {validatedMemories.length === 0 ? (
                <div class="empty-state">
                    <p>No validated memories yet</p>
                </div>
            ) : (
                <div class="memory-list">
                    {validatedMemories.map((memory) => (
                        <div class="memory-card validated">
                            <div class="memory-header">
                                <span class="memory-type">{memory.type}</span>
                                <span class="memory-confidence">
                                    Confidence: {((memory.confidence || 0) * 100).toFixed(0)}%
                                </span>
                            </div>
                            <p class="memory-content">{memory.content}</p>
                            <p class="memory-date">
                                Approved: {memory.reviewedAt ? new Date(memory.reviewedAt).toLocaleDateString() : 'N/A'}
                            </p>
                        </div>
                    ))}
                </div>
            )}
        </div>

        <!-- Rejected Tab -->
        <div id="rejected-tab" class="tab-content">
            {rejectedMemories.length === 0 ? (
                <div class="empty-state">
                    <p>No rejected memories</p>
                </div>
            ) : (
                <div class="memory-list">
                    {rejectedMemories.map((memory) => (
                        <div class="memory-card rejected">
                            <div class="memory-header">
                                <span class="memory-type">{memory.type}</span>
                            </div>
                            <p class="memory-content">{memory.content}</p>
                            {memory.reviewNotes && (
                                <p class="memory-notes">Reason: {memory.reviewNotes}</p>
                            )}
                        </div>
                    ))}
                </div>
            )}
        </div>
    </div>

    <script is:inline>
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
            });
        });

        // Approve memory
        async function approveMemory(id) {
            if (!confirm('Approve this memory? It will influence future processing.')) return;
            
            const res = await fetch(`/api/memories/${id}/approve`, { method: 'POST' });
            if (res.ok) {
                document.querySelector(`[data-id="${id}"]`).remove();
                location.reload();
            } else {
                alert('Failed to approve memory');
            }
        }

        // Reject memory
        async function rejectMemory(id) {
            const reason = prompt('Reason for rejection (optional):');
            
            const res = await fetch(`/api/memories/${id}/reject`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ notes: reason || '' })
            });
            
            if (res.ok) {
                document.querySelector(`[data-id="${id}"]`).remove();
                location.reload();
            } else {
                alert('Failed to reject memory');
            }
        }
    </script>

    <style>
        .memories-admin {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        h1 {
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        
        .description {
            color: #6b7280;
            margin-bottom: 2rem;
        }
        
        .tabs {
            display: flex;
            gap: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 1.5rem;
        }
        
        .tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1rem;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }
        
        .tab.active {
            color: #d97706;
            border-bottom-color: #d97706;
        }
        
        .badge {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }
        
        .badge.pending { background: #fef3c7; color: #92400e; }
        .badge.validated { background: #d1fae5; color: #065f46; }
        .badge.rejected { background: #fee2e2; color: #991b1b; }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #9ca3af;
        }
        
        .memory-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .memory-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            border-left: 4px solid;
        }
        
        .memory-card.pending { border-left-color: #f59e0b; }
        .memory-card.validated { border-left-color: #10b981; }
        .memory-card.rejected { border-left-color: #ef4444; }
        
        .memory-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }
        
        .memory-type {
            background: #f3f4f6;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            text-transform: capitalize;
        }
        
        .memory-confidence {
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        .memory-content {
            color: #1f2937;
            line-height: 1.6;
            margin-bottom: 0.75rem;
        }
        
        .memory-source, .memory-date, .memory-notes {
            color: #9ca3af;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }
        
        .memory-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
        }
        
        .btn.approve {
            background: #d1fae5;
            color: #065f46;
        }
        
        .btn.reject {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .btn:hover {
            opacity: 0.8;
        }
    </style>
</BaseLayout>
