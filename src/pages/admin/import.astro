---
import BaseLayout from "../../layouts/BaseLayout.astro";

export const prerender = false;

const isDev = import.meta.env.DEV;
---

<BaseLayout title="Import Research">
  <div class="max-w-4xl mx-auto px-4 py-12">
    <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-8">
      Import Research
    </h1>

    <div
      class={`rounded-lg p-4 mb-8 ${
        isDev
          ? "bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800"
          : "bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800"
      }`}
    >
      <p
        class={`text-sm ${isDev ? "text-green-800 dark:text-green-200" : "text-blue-800 dark:text-blue-200"}`}
      >
        {
          isDev ? (
            <>
              üîß <strong>Dev Mode</strong>: Files will be written directly to
              your local <code>src/content/concepts/</code> folder.
            </>
          ) : (
            <>
              üöÄ <strong>Production Mode</strong>: Files will be committed to
              GitHub via API. Vercel will auto-deploy in ~2 minutes.
            </>
          )
        }
      </p>
    </div>

    <form class="space-y-6" id="import-form">
      <div>
        <label
          for="bibtex"
          class="block text-sm font-medium text-gray-700 dark:text-gray-300"
        >
          BibTeX Content
        </label>
        <div class="mt-1">
          <textarea
            id="bibtex"
            name="bibtex"
            rows="12"
            class="shadow-sm block w-full bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm border border-gray-300 dark:border-gray-700 rounded-md font-mono p-3"
            placeholder="@article{nakamoto2008,
  title={Bitcoin: A Peer-to-Peer Electronic Cash System},
  author={Nakamoto, Satoshi},
  year={2008},
  abstract={A purely peer-to-peer version of electronic cash...}
}"
          ></textarea>
        </div>
        <p class="mt-2 text-sm text-gray-500">
          Paste your BibTeX entries here. Multiple entries are supported.
        </p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label
            for="project"
            class="block text-sm font-medium text-gray-700 dark:text-gray-300"
            >Target Project</label
          >
          <select
            id="project"
            name="project"
            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-700 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
          >
            <option value="auto">Auto-detect from content</option>
            <option value="ndani">Ndani (IoT Privacy)</option>
            <option value="msingi">Msingi (Device Privacy)</option>
            <option value="edgechain">EdgeChain (Agricultural AI)</option>
          </select>
        </div>
      </div>

      <div class="flex justify-end gap-4">
        <button
          type="button"
          id="clear-btn"
          class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 transition-colors"
        >
          Clear
        </button>
        <button
          type="submit"
          id="submit-btn"
          class="inline-flex items-center justify-center gap-2 py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
        >
          <span id="btn-text">Import & Generate</span>
          <svg
            id="btn-spinner"
            class="hidden animate-spin h-4 w-4"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
        </button>
      </div>
    </form>

    <div id="result" class="mt-8 hidden">
      <div id="result-header" class="flex items-center gap-2 mb-3">
        <span id="result-icon"></span>
        <h3 id="result-title" class="text-lg font-medium"></h3>
      </div>
      <pre
        id="result-content"
        class="bg-gray-100 dark:bg-gray-800 p-4 rounded-md overflow-auto text-sm max-h-96">
      </pre>
    </div>
  </div>
</BaseLayout>

<script define:vars={{ isDev }}>
  const form = document.getElementById("import-form");
  const resultDiv = document.getElementById("result");
  const resultContent = document.getElementById("result-content");
  const resultTitle = document.getElementById("result-title");
  const resultIcon = document.getElementById("result-icon");
  const resultHeader = document.getElementById("result-header");
  const submitBtn = document.getElementById("submit-btn");
  const btnText = document.getElementById("btn-text");
  const btnSpinner = document.getElementById("btn-spinner");
  const clearBtn = document.getElementById("clear-btn");

  // Determine which endpoint to use
  const endpoint = isDev ? "/api/process-research" : "/api/import-to-github";

  clearBtn?.addEventListener("click", () => {
    document.getElementById("bibtex").value = "";
    resultDiv?.classList.add("hidden");
  });

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);

    // Show loading state
    submitBtn.disabled = true;
    btnText.textContent = "Processing...";
    btnSpinner?.classList.remove("hidden");
    resultDiv?.classList.remove("hidden");
    resultContent.textContent =
      "Connecting to " + (isDev ? "local filesystem" : "GitHub API") + "...";
    resultHeader?.classList.remove("text-green-600", "text-red-600");

    try {
      const response = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });

      const result = await response.json();

      if (result.success) {
        resultIcon.textContent = "‚úÖ";
        resultTitle.textContent = "Success!";
        resultHeader?.classList.add("text-green-600");
        resultContent.textContent = JSON.stringify(result, null, 2);

        if (!isDev) {
          resultContent.textContent +=
            "\n\nüîÑ Vercel is now rebuilding your site. Check back in ~2 minutes.";
        }
      } else {
        resultIcon.textContent = "‚ùå";
        resultTitle.textContent = "Error";
        resultHeader?.classList.add("text-red-600");
        resultContent.textContent = result.error || "Unknown error occurred.";
      }
    } catch (error) {
      resultIcon.textContent = "‚ùå";
      resultTitle.textContent = "Network Error";
      resultHeader?.classList.add("text-red-600");
      resultContent.textContent = "Failed to connect: " + error.message;
    } finally {
      submitBtn.disabled = false;
      btnText.textContent = "Import & Generate";
      btnSpinner?.classList.add("hidden");
    }
  });
</script>
