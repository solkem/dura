---
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout title="Import Research | Midnight Learning">
  <div class="max-w-4xl mx-auto">
    <div class="mb-12 border-b border-slate-100 pb-8">
      <h1 class="text-4xl font-extrabold text-slate-900 mb-4">Mendeley Research Import</h1>
      <p class="text-lg text-slate-600">
        Upload your Mendeley <code>.bib</code> export to automatically extract concepts and generate documentation stubs.
      </p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
      <!-- Upload Section -->
      <div class="p-8 bg-slate-50 border-2 border-dashed border-slate-300 rounded-2xl hover:border-brand-400 transition-colors text-center group cursor-pointer" id="drop-zone">
        <div class="mb-6 text-brand-500 group-hover:scale-110 transition-transform duration-300">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
        </div>
        <h3 class="text-xl font-bold text-slate-800 mb-2">Drop BibTeX File Here</h3>
        <p class="text-slate-500 mb-6 text-sm">or click to select file</p>
        <input type="file" id="file-input" accept=".bib" class="hidden" />
        <button class="px-6 py-2 bg-white border border-slate-200 text-slate-700 font-bold rounded-full hover:bg-slate-50 hover:text-brand-600 transition-colors shadow-sm" onclick="document.getElementById('file-input').click()">
          Select BibTeX File
        </button>
      </div>

      <!-- Filters Section -->
      <div class="space-y-6">
        <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm">
            <h3 class="font-bold text-slate-800 mb-4">Import Settings</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Target Project</label>
                    <select id="project-select" class="w-full rounded-lg border-slate-200 text-slate-600 focus:border-brand-500 focus:ring-brand-500">
                        <option value="auto">Safe Auto-Detect (Recommended)</option>
                        <option value="msingi">Msingi</option>
                        <option value="edgechain">EdgeChain</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Target Research Section</label>
                    <select id="section-select" class="w-full rounded-lg border-slate-200 text-slate-600 focus:border-brand-500 focus:ring-brand-500">
                        <option value="auto">None / General</option>
                        <option value="background">Background & Context</option>
                        <option value="related_work">Related Work</option>
                        <option value="methodology">Methodology</option>
                        <option value="evaluation">Evaluation</option>
                        <option value="discussion">Discussion</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="bg-blue-50 p-6 rounded-xl border border-blue-100 shadow-sm">
          <h3 class="font-bold text-blue-800 mb-2 flex items-center gap-2">
            ℹ️ Workflow Tip
          </h3>
          <p class="text-sm text-blue-700 leading-relaxed">
            Use the dropdowns above to tag all imported papers. For example, select <strong>Msingi</strong> and <strong>Related Work</strong> to auto-file a batch of PDFs into that specific section of the documentation.
          </p>
        </div>
      </div>
    </div>

    <!-- Results Area -->
    <div id="results-area" class="mt-12 hidden">
      <h3 class="text-2xl font-bold text-slate-900 mb-6">Extraction Results</h3>
      <div class="bg-slate-900 rounded-xl p-6 font-mono text-sm text-slate-300 overflow-auto max-h-96" id="logs">
        <div class="animate-pulse">Waiting for file...</div>
      </div>
    </div>
  </div>

  <script>
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const projectSelect = document.getElementById('project-select') as HTMLSelectElement;
    const sectionSelect = document.getElementById('section-select') as HTMLSelectElement;
    const resultsArea = document.getElementById('results-area');
    const logs = document.getElementById('logs');

    // Handle Drag & Drop
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('border-brand-500', 'bg-brand-50');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('border-brand-500', 'bg-brand-50');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-brand-500', 'bg-brand-50');
        const files = e.dataTransfer.files;
        if (files.length) handleFile(files[0]);
    });

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length) handleFile(e.target.files[0]);
    });

    async function handleFile(file) {
        resultsArea.classList.remove('hidden');
        logs.innerHTML = `<div class="text-brand-400">Processing ${file.name}...</div>`;
        
        const text = await file.text();
        const project = projectSelect.value;
        const section = sectionSelect.value;
        
        try {
            const response = await fetch('/api/process-research', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ bibtex: text, project, section })
            });
            
            const data = await response.json();
            
            if (data.success) {
                logs.innerHTML += `<div class="text-emerald-400 mt-2">✓ Success! Processed ${data.count} entries.</div>`;
                logs.innerHTML += `<div class="text-slate-400 mt-2">Generated Drafts:</div>`;
                data.slugs.forEach(slug => {
                    logs.innerHTML += `<div class="pl-4 text-emerald-300 hover:text-emerald-200"><a href="/concepts/${slug}" target="_blank">/concepts/${slug}</a></div>`;
                });
            } else {
                logs.innerHTML += `<div class="text-red-400 mt-2">Error: ${data.error}</div>`;
            }
        } catch (e) {
             logs.innerHTML += `<div class="text-red-400 mt-2">Critical Error: ${e.message}</div>`;
        }
    }
  </script>
</BaseLayout>
