---
import BaseLayout from "../../layouts/BaseLayout.astro";

export const prerender = false;

const isDev = import.meta.env.DEV;
---

<BaseLayout title="Import Research">
  <div class="max-w-4xl mx-auto px-4 py-12">
    <div class="mb-8">
      <a
        href="/admin"
        class="text-sm font-medium text-slate-500 hover:text-amber-600 transition-colors"
      >
        &larr; Back to Admin
      </a>
    </div>

    <h1 class="text-3xl font-bold text-stone-900 mb-8">
      Import Research (Legacy)
    </h1>

    <!-- Deprecation Notice -->
    <div class="rounded-lg p-4 mb-8 bg-amber-100 border border-amber-300">
      <p class="text-sm text-amber-900">
        ‚ö†Ô∏è <strong>This page is deprecated.</strong> Use the
        <a href="/admin/papers" class="font-bold underline hover:text-amber-700"
          >AI Paper Processor</a
        >
        instead to add papers with full AI-powered curation and synthesis.
      </p>
    </div>

    <div
      class={`rounded-lg p-4 mb-8 ${
        isDev
          ? "bg-green-50 border border-green-200"
          : "bg-stone-100 border border-stone-200"
      }`}
    >
      <p class={`text-sm ${isDev ? "text-green-800" : "text-stone-700"}`}>
        {
          isDev ? (
            <>
              üîß <strong>Dev Mode</strong>: Files will be written directly to
              your local{" "}
              <code class="bg-green-100 px-1 rounded">
                src/content/concepts/
              </code>{" "}
              folder.
            </>
          ) : (
            <>
              üìÅ <strong>Legacy Mode</strong>: This imports BibTeX as static MDX
              files to GitHub. For database-backed papers with AI synthesis, use{" "}
              <a href="/admin/papers" class="font-bold underline">
                AI Paper Processor
              </a>
              .
            </>
          )
        }
      </p>
    </div>

    <form class="space-y-6" id="import-form">
      <div>
        <label
          for="bibtex"
          class="block text-sm font-medium text-stone-700 mb-2"
        >
          BibTeX Content
        </label>
        <div class="mt-1">
          <textarea
            id="bibtex"
            name="bibtex"
            rows="12"
            class="shadow-sm block w-full bg-white text-stone-900 focus:ring-amber-500 focus:border-amber-500 sm:text-sm border border-stone-300 rounded-md font-mono p-3"
            placeholder="@article{nakamoto2008,
  title={Bitcoin: A Peer-to-Peer Electronic Cash System},
  author={Nakamoto, Satoshi},
  year={2008},
  abstract={A purely peer-to-peer version of electronic cash...}
}"
          ></textarea>
        </div>
        <p class="mt-2 text-sm text-stone-500">
          Paste your BibTeX entries here. Multiple entries are supported.
        </p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label
            for="project"
            class="block text-sm font-medium text-stone-700 mb-2"
            >Target Project</label
          >
          <select
            id="project"
            name="project"
            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-stone-300 focus:outline-none focus:ring-amber-500 focus:border-amber-500 sm:text-sm rounded-md bg-white text-stone-900 border"
          >
            <option value="auto">Auto-detect from content</option>
            <option value="ndani">Ndani (IoT Privacy)</option>
            <option value="msingi">Msingi (Device Privacy)</option>
            <option value="edgechain">EdgeChain (Agricultural AI)</option>
          </select>
        </div>
      </div>

      <div class="flex justify-end gap-4">
        <button
          type="button"
          id="clear-btn"
          class="px-4 py-2 text-stone-600 hover:text-stone-900 transition-colors"
        >
          Clear
        </button>
        <button
          type="submit"
          id="submit-btn"
          class="inline-flex items-center justify-center gap-2 py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-amber-600 hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
        >
          <span id="btn-text">Import & Generate</span>
          <svg
            id="btn-spinner"
            class="hidden animate-spin h-4 w-4"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
        </button>
      </div>
    </form>

    <div id="result" class="mt-8 hidden">
      <div id="result-header" class="flex items-center gap-2 mb-3">
        <span id="result-icon"></span>
        <h3 id="result-title" class="text-lg font-medium text-stone-900"></h3>
      </div>
      <pre
        id="result-content"
        class="bg-stone-100 text-stone-800 p-4 rounded-md overflow-auto text-sm max-h-96">
      </pre>
    </div>
  </div>
</BaseLayout>

<script define:vars={{ isDev }}>
  const form = document.getElementById("import-form");
  const resultDiv = document.getElementById("result");
  const resultContent = document.getElementById("result-content");
  const resultTitle = document.getElementById("result-title");
  const resultIcon = document.getElementById("result-icon");
  const resultHeader = document.getElementById("result-header");
  const submitBtn = document.getElementById("submit-btn");
  const btnText = document.getElementById("btn-text");
  const btnSpinner = document.getElementById("btn-spinner");
  const clearBtn = document.getElementById("clear-btn");

  // Determine which endpoint to use
  const endpoint = isDev ? "/api/process-research" : "/api/import-to-github";

  clearBtn?.addEventListener("click", () => {
    document.getElementById("bibtex").value = "";
    resultDiv?.classList.add("hidden");
  });

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);

    // Show loading state
    submitBtn.disabled = true;
    btnText.textContent = "Processing...";
    btnSpinner?.classList.remove("hidden");
    resultDiv?.classList.remove("hidden");
    resultContent.textContent =
      "Connecting to " + (isDev ? "local filesystem" : "GitHub API") + "...";
    resultTitle.textContent = "Processing...";
    resultTitle.className = "text-lg font-medium text-stone-600";

    try {
      const response = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });

      const result = await response.json();

      if (result.success) {
        resultIcon.textContent = "‚úÖ";
        resultTitle.textContent = "Success!";
        resultTitle.className = "text-lg font-medium text-green-700";
        resultContent.textContent = JSON.stringify(result, null, 2);

        if (!isDev) {
          resultContent.textContent +=
            "\n\nüîÑ GitHub Actions is now rebuilding your site. Check back in ~2 minutes.";
        }
      } else {
        resultIcon.textContent = "‚ùå";
        resultTitle.textContent = "Error";
        resultTitle.className = "text-lg font-medium text-red-700";
        resultContent.textContent = result.error || "Unknown error occurred.";
      }
    } catch (error) {
      resultIcon.textContent = "‚ùå";
      resultTitle.textContent = "Network Error";
      resultTitle.className = "text-lg font-medium text-red-700";
      resultContent.textContent = "Failed to connect: " + error.message;
    } finally {
      submitBtn.disabled = false;
      btnText.textContent = "Import & Generate";
      btnSpinner?.classList.add("hidden");
    }
  });
</script>
